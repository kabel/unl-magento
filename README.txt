== NOTICE ==

Because the files in the app/code/local/AW and app/code/local/Webshopapps are purchased extentions to the magento project, they are NOT distributable. For this reason, anonymous access to the codebase has been blocked.

== INSTALLATION ==

The 1.4 branch of magento requires a little fine tuning for configuration purposes.
A patch ( data/magento1.4.patch ) has been included to run in the magento project space to accoplish this.

    cd /path/to/magento
    patch -p0 < /path/to/unl-magento/data/magento1.4.patch

The UNL extensions for magento are handled through a repository of directories and files that need to be symlinked in the magento directory structure.
For reference the two SVN projects are hosted at the following locations:
[magento] : http://svn.magentocommerce.com/source/branches/1.4
[unl-magento] : http://its-gforge.unl.edu/svn/unl-magento/trunk

cd /path/to/magento
ln -s /path/to/unl-magento/app/code/community/Zenprint app/etc/code/community/
ln -s /path/to/unl-magento/app/code/local/Unl app/code/local/Unl
ln -s /path/to/unl-magento/app/code/local/AW app/code/local/AW
ln -s /path/to/unl-magento/app/code/local/Webshopapps app/code/local/Webshopapps
ln -s /path/to/unl-magento/app/design/frontend/unl app/design/frontend/unl
ln -s /path/to/unl-magento/app/design/adminhtml/default/unl/ app/design/adminhtml/default/unl
ln -s /path/to/unl-magento/app/etc/modules/Unl_All.xml app/etc/modules/
ln -s /path/to/unl-magento/app/etc/modules/Zenprint_Xajax.xml app/etc/modules/
ln -s /path/to/unl-magento/app/etc/modules/Zenprint_Ordership.xml app/etc/modules/
ln -s /path/to/unl-magento/errors/unl errors/
ln -s /path/to/unl-magento/errors/local.xml errors/
ln -s /path/to/unl-magento/js/xajax_js js/
ln -s /path/to/unl-magento/lib/SimpleCAS lib/SimpleCAS
ln -s /path/to/unl-magento/lib/SimpleCAS.php lib/SimpleCAS.php
ln -s /path/to/unl-magento/lib/UNL lib/UNL
ln -s /path/to/unl-magento/lib/Xajax lib/
ln -s /path/to/unl-magento/skin/frontend/unl skin/frontend/unl

For the "online" install to run, you must
    chmod a+w app/etc
    chmod -R a+w var/
    chmod -R a+w media/
    
Once installation is complete you can remove write permissions from app/etc
    chmod o-w app/etc
    
After "online" installation, there are a couple of MySQL data imports that need to occur (separated for install speed)
NOTE: These MySQL queries/scripts will take A WHILE to run as they insert around half a million records. Be patient!

cd /path/to/unl-magento/data/tax

* Unzip NEB.txt.zip
* Login to mysql client and use the magento database

LOAD DATA LOCAL INFILE 'NEB.txt'
INTO TABLE `unl_tax_boundary`
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\r\n';

TRUNCATE TABLE `tax_calculation_rate`;

LOAD DATA LOCAL INFILE 'allRates.csv'
REPLACE INTO TABLE `tax_calculation_rate`
FIELDS TERMINATED BY ',' ENCLOSED BY '"'
LINES TERMINATED BY '\r'
(`code`, `tax_country_id`, `tax_region_id`, `tax_postcode`, `rate`);

SOURCE MageTaxSetup.sql;

SOURCE MageTaxCalculationInit.sql


== CONFIGURATION ==

From the Admin interface, the following configuration settings should be set to ensure proper template layout.
In the navigation go to System > Configuration

General > Design (left tab)
    Package:
        Current Package Name: unl
    HTML Head:
        Default Title: UNL | Marketplace
        Default Keywords: E-commerce
    Footer:
        Copyright: &copy; 2010 University of Nebraska&ndash;Lincoln | Lincoln, NE 68588 | 402-472-7211 | <a href="http://www.unl.edu/ucomm/aboutunl/" title="Click here to know more about UNL">About UNL</a> | <a href="http://www1.unl.edu/comments/" title="Click here to direct your comments and questions">comments?</a>

General > Store Email Addresses
    General contact
        Sender email: storefront@unl.edu
    Sales representative
        Sender email: storefront@unl.edu
    Customer Support:
        Sender email: storefront@unl.edu
        
General > Contacts
    Email Options:
        Send Emails To: storefront@unl.edu

Catalog > Catalog
    Search Engine Optimizations:
        Popular search terms: Disable
        Autogenerated site map: Disable
        Category URL Suffix:
        Page Title Separator: |

Catalog > RSS Feeds
    Rss Config:
        Enable RSS: Enable
    Wishlist:
        Enable RSS: Enable
    Catalog:
        New Products: Enable
        Top Level Category: Enable
    Order:
        Customer Order Status Notification: Enable
        
Customers > Customer Configuration
    Account Sharing Options:
        Share Customer Accounts: Global

Sales > Sales
    Gift Messages:
        Allow Gift Messages for Order Items: Yes

Sales > Tax
    Calculation:
        Apply Tax After Discount: Yes

Sales > Shipping Settings
    Origin:
        Region/State: Nebraska
        ZIP/Postal Code: 68588

Sales > Shipping Methods
    * Configure each carrier per the business requirements (requires API credentials)
    * Disable unused carriers

Sales > Payment Methods
    * Configure each provider per the business requirement (requires API credentials)
    * Disable unused providers
    * PayPal options may also require setting up Sales > PayPal Accounts config

Advanced > Developer
    JavaScript Settings:
        Merge JavaScript Files (beta): Yes


== MAINTENANCE ==

When running maintenance on the magento project that may require temporary shutdown of magento run the following command.
    cd /path/to/magento
    /path/to/unl-magento/swapMaintenance.sh
Once the maintenance is over run the command again to restore access


== TAX RATE MAINTENANCE ==

Currently, there is no automated way to update the tax rates for magento. However, the SST Rate and Boundary Data provided by the NE Dept of Rev (http://salestaxrates.ne.gov/nedor/) can be normalized into something magento can use.

NOTE: This normalization process requires the use of the latest version of Excel (due to the limitations on row count with other spreadsheet applications)

1) Download the SST data from the above mentioned site
2) Unzip the file and load the two files into some temporary MySQL database. (The schema for the SST tables is provided in data/tax/SSTSchema.sql)
   The NEB######.txt file loads into the `boundaries` table
   The NER######.txt file loads into the `rates` table
3) Export the results of the following queries into a simple format, like CSV

-- USED TO GET NEW CITY RATES LOOKUP TABLE
SELECT jurisdiction_fips_code, general_tax_rate_intra
FROM rates r
WHERE jurisdiction_type = 01
  AND NOW() BETWEEN begin_date AND end_date
ORDER BY jurisdiction_fips_code

-- USED TO GET NEW COUNTY RATES LOOKUP TABLE
SELECT jurisdiction_fips_code, general_tax_rate_intra
FROM rates r
WHERE jurisdiction_type = 00
  AND NOW() BETWEEN begin_date AND end_date
ORDER BY jurisdiction_fips_code

-- USED TO GET NEW STATE RATE (NOTE: NE is fips 31)
SELECT jurisdiction_fips_code, general_tax_rate_intra
FROM rates r
WHERE jurisdiction_type = 45
  AND NOW() BETWEEN begin_date AND end_date
ORDER BY jurisdiction_fips_code

-- USED TO GET ALL CURRENT ZIP+4 POSSIBILITIES FOR CITYS
SELECT zip_code, plus_4, fips_place_number
FROM boundaries b
WHERE record_type = 'A'
  AND NOW() BETWEEN begin_date AND end_date
  AND fips_place_number <> ''
ORDER BY zip_code, plus_4, fips_place_number DESC

-- USED TO GET ALL CURRENT ZIP+4 POSSIBILITIES FOR COUNTIES
SELECT zip_code, plus_4, fips_county_code
FROM boundaries b
WHERE record_type = 'A'
  AND NOW() BETWEEN begin_date AND end_date
  AND fips_county_code <> ''
ORDER BY zip_code, plus_4, fips_county_code DESC

4) Open the tax data normalization spreadsheet at data/tax/taxes.xlsx (it may take a while to load, it's huge!)
   Use the data from query 1 to populate the columns of the 'City FIPS' sheet (NOTE: The zero padding on FIPS is important and must be maintained)
   Use the data from query 2 to populate the columns of the 'County FIPS' sheet (NOTE: The zero padding on FIPS is important and must be maintained)
   Use the data from query 3 to populate the row labeled 'US-NE-*' of the 'State Tax' sheet (NOTE: The rate needs to be multipled by 100)
   Use the data from query 4 to populate the first 3 columns of the 'City Tax' sheet
   Use the data from query 5 to populate the first 3 columns of the 'County Tax' sheet
5) Excel should have now calcuated all of the data that needs to be added to magento. Now all of the rates need to be saved into CSV format.
   The easiest way to accomplish this is to use a text editor (Like Notepad++ or TextWrangler).
   Copy the first 5 columns of the 'State Tax' sheet, Paste into a new text file
   Copy the last 5 columns of the 'City Tax' sheet, Paste into the text file
   Copy the last 5 columns of the 'County Tax' sheet, Paste into the text file
6) You can now format the text file into a data format you can load into mysql.
   It's recommended to use CSV. To transform the pasted data from Tab Separated Values, use the text editor's find/replace capabilities to insert " at the beginning and end of every line and replace tabs with ","
7) Log into MySQL and use the magento DB
8) TRUNCATE the `unl_tax_boundary` table
9) LOAD the boundary data from NEB######.txt
10) TRUNCATE the `tax_calculation_rate` table
11) LOAD the text file you created into `tax_calculation_rate` using (`code`, `tax_country_id`, `tax_region_id`, `tax_postcode`, `rate`) columns
12) SOURCE the sql file at data/tax/MageTaxCalculationInit.sql


== HELP ==

For help on general design and configuration refer to the documentation provided by Varien at http://www.magentocommerce.com/

A listing of the events that handlers can be written for is in file data/dispatcheventlist.xls. It may not be up to date with the current version of Magento.